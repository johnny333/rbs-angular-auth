(function(){angular.module("rbs-angular-auth",["ngStorage","rbs-angular-core"]),angular.module("rbs-angular-auth-ui-router",["ui.router","rbs-angular-auth"]),angular.module("rbs-angular-auth-samples",["rbs-angular-auth-samples"])}).call(this),function(){angular.module("rbs-angular-auth").factory("TokenManager",["$log","$localStorage","$rootScope","Configuration",function(r,t,n,e){var a,o,u,i,c,l;return i=e.JWT_STORAGE_KEY,c=e.JWT_STORE_EVENT,a=e.JWT_CLEAR_EVENT,u=e.JWT_INJECTOR,o=e.JWT_EXTRACTOR,new(l=function(){function e(){}return e.prototype.storeRaw=function(e){return this.getRaw()!==e?(r.debug("Store JWT token: ",e),t[i]=e,n.$broadcast(c,this,e)):void 0},e.prototype.getRaw=function(){return t[i]},e.prototype.clear=function(){var e;return e=this.getRaw(),r.debug("Cleared JWT token: ",e),delete t[i],n.$broadcast(a,this,e)},e.prototype.inject=function(r,t){return u(r,t),r},e.prototype.extract=function(r){return o(r)},e}())}])}.call(this),function(){var r,t,n,e,a,o,u,i,c,l,s,p,T,f,R,h,g,E,d,O,y,A,S=[].slice,I=function(r,t){function n(){this.constructor=r}for(var e in t)m.call(t,e)&&(r[e]=t[e]);return n.prototype=t.prototype,r.prototype=new n,r.__super__=t.prototype,r},m={}.hasOwnProperty;t=function(){function r(){var r;r=1<=arguments.length?S.call(arguments,0):[],this.permissions=r}return r.evalPermission=function(r,t){return function(n){return angular.isString(n)?t(r,n):angular.isFunction(null!=n?n.eval:void 0)?n.eval(r,t):void 0}},r}(),r=function(r){function n(){return n.__super__.constructor.apply(this,arguments)}return I(n,r),n.prototype.eval=function(r,n){return _.every(this.permissions,t.evalPermission(r,n))},n.prototype.toJSON=function(){return{and:this.permissions}},n}(t),n=function(r){function n(){return n.__super__.constructor.apply(this,arguments)}return I(n,r),n.prototype.eval=function(r,n){return _.some(this.permissions,t.evalPermission(r,n))},n.prototype.toJSON=function(){return{or:this.permissions}},n}(t),a=Parsimmon.alt,O=Parsimmon.seq,l=Parsimmon.lazy,g=Parsimmon.regex,y=Parsimmon.string,h=Parsimmon.optWhitespace,s=function(r){return r.skip(h)},p=s(y("(")),E=s(y(")")),R=s(y("|")),f=s(y("&")),T=s(g(/[0-9a-z_\-\.]+/i)),d=l("rule",function(){return O(o,c.many()).map(function(r){var t,e;return t=r[0],e=r[1],function(r,t,n){n.prototype=r.prototype;var e=new n,a=r.apply(e,t);return Object(a)===a?a:e}(n,[t].concat(S.call(e)),function(){})})}),A=p.then(d).skip(E).or(T),u=f.then(A),o=O(A,u.many()).map(function(t){var n,e;return n=t[0],e=t[1],e.length?function(r,t,n){n.prototype=r.prototype;var e=new n,a=r.apply(e,t);return Object(a)===a?a:e}(r,[n].concat(S.call(e)),function(){}):n}),c=R.then(o),i=O(A,c.many()).map(function(r){var t,e;return t=r[0],e=r[1],e.length?function(r,t,n){n.prototype=r.prototype;var e=new n,a=r.apply(e,t);return Object(a)===a?a:e}(n,[t].concat(S.call(e)),function(){}):t}),e=function(){function r(){}return r.parse=_.memoize(function(r){return d.parse((null!=r?r.trim():void 0)||"")}),r}(),angular.module("rbs-angular-auth").factory("RuleParser",["$log",function(r){return e}])}.call(this),function(){angular.module("rbs-angular-auth").factory("JWT",["$log","ErrorFactory","Configuration",function(r,t,n){var e;return e=function(){function r(){}return r.format=function(r,t,n){return angular.isObject(r)&&angular.isObject(t)&&null!=n?KJUR.jws.JWS.sign(null,angular.toJson(r),angular.toJson(t),n):void 0},r.parse=function(r,e){var a,o,u,i,c;if(null!=r)return i=r.split("."),a=i[0],u=i[1],c=i[2],o=e?(angular.isNumber(e)?e=""+e:void 0,KJUR.jws.JWS.verify(r,e)):!0,o||t["throw"](n.ERROR_STATUS.NOT_AUTHORIZED,n.ERROR_CODE.INVALID_TOKEN_SIGNATURE,"Invalid JWT token signature"),{header:angular.fromJson(KJUR.jws.JWS.readSafeJSONString(b64utos(a))),payload:angular.fromJson(KJUR.jws.JWS.readSafeJSONString(b64utos(u)))}},r}()}])}.call(this),function(){var r=function(r,t){return function(){return r.apply(t,arguments)}};angular.module("rbs-angular-auth").factory("TokenInterceptor",["$log","$q","TokenManager","Configuration",function(t,n,e,a){var o;return new(o=function(){function t(){this.request=r(this.request,this),this.response=r(this.response,this)}return t.prototype.isEnabled=function(r){return angular.isString(a.HTTP_URL_FILTER)?S(r.url).startsWith(a.HTTP_URL_FILTER):angular.isFunction(a.HTTP_URL_FILTER)?a.HTTP_URL_FILTER(r.url):_.isRegExp(a.HTTP_URL_FILTER)?a.HTTP_URL_FILTER.test(r.url):!0},t.prototype.response=function(r){var t;return this.isEnabled(r.config)&&(t=e.extract(r),null!=t&&e.storeRaw(t)),r},t.prototype.request=function(r){var t,n,o;return this.isEnabled(r)?(t=null!=(n=r.params)?n[a.JWT_REQUEST_PARAM]:void 0,o=null!=t?(delete r.params[a.JWT_REQUEST_PARAM],t):e.getRaw(),null!=o?e.inject(r,o)||r:r):r},t}())}])}.call(this),function(){var r=[].indexOf||function(r){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===r)return t;return-1};angular.module("rbs-angular-auth").factory("SecurityErrorInterceptor",["$log","$rootScope","$q","Configuration","ErrorFactory",function(t,n,e,a,o){var u;return new(u=function(){function t(){}return t.prototype.responseError=function(t){var u,i,c,l;return c=t.status,u=r.call(a.HTTP_AUTHORIZATION_ERROR_STATUS||[],c)>=0?(i=angular.isString(t.data)?t.data:angular.isString(null!=(l=t.data)?l.message:void 0)?t.data.message:"Server returned authorization error",u=o.create(t.status,a.ERROR_CODE.NO_HTTP_AUTHORIZATION,i,t),n.$broadcast(a.HTTP_AUTHORIZATION_ERROR_EVENT,u),u):t,e.reject(u)},t}())}])}.call(this),function(){angular.module("rbs-angular-auth").service("SecurityCtrl",["$log","$q","$rootScope","Configuration","ErrorFactory","JWT","RuleParser","TokenManager",function(r,t,n,e,a,o,u,i){var c;return c=function(){function c(){this.principal=void 0,this.payload=void 0,n.$on(e.JWT_STORE_EVENT,function(r){return function(){return r.initialize()}}(this)),n.$on(e.JWT_CLEAR_EVENT,function(r){return function(){return r.initialize()}}(this)),this.initialize()}return c.prototype.clearCaches=function(){var r,t,n;return"function"==typeof(r=this.isAuthorized.cache).clear&&r.clear(),"function"==typeof(t=this.$readPrincipal.cache).clear&&t.clear(),"function"==typeof(n=this.$readPayload.cache).clear?n.clear():void 0},c.prototype.initialize=function(){var r,t;return this.clearCaches(),this.payload=this.$readPayload(),t=function(r){return function(t){return r.clearCaches(),r.principal=t}}(this),r=function(r){return function(){return r.clearCaches(),r.principal=void 0}}(this),this.getPrincipal().then(t,r)},c.prototype.$fetchPrincipal=function(r){return r},c.prototype.$$readPayload=function(){var t,n,e,a,u;return a=i.getRaw(),u=function(){var n;try{return o.parse(a)}catch(n){return t=n,r.error("Can't parse token:",a,t),i.clear()}}(),null!=u?(n=u.header,e=u.payload):void 0},c.prototype.$readPayload=_.memoize(c.prototype.$$readPayload,function(){return"SecurityCtrl-readPayload"}),c.prototype.$$readPrincipal=function(){var r;return r=this.$readPayload(),null!=r?t.when(this.$fetchPrincipal(r)):t.reject()},c.prototype.$readPrincipal=_.memoize(c.prototype.$$readPrincipal,function(){return"SecurityCtrl-readPrincipal"}),c.prototype.getPrincipal=function(){return this.$readPrincipal()},c.prototype.isAuthenticated=function(){return null!=this.payload},c.prototype.$$isAuthorized=function(r,t){var n;return null==r?null!=t:null!=t&&angular.isFunction(e.JWT_PERMISSION_CHECK)?(n=u.parse(r),n.status?n.value.eval(t,e.JWT_PERMISSION_CHECK)===!0:a["throw"](e.ERROR_STATUS.BAD_REQUEST,e.ERROR_CODE.INVALID_AUTHORIZATION_RULE,"Can't parse authorization rule: \""+r+'"')):!1},c.prototype.$isAuthorized=function(r){return this.$$isAuthorized(r,this.payload)},c.prototype.isAuthorized=_.memoize(c.prototype.$isAuthorized,function(r){return r||"SecurityCtrl-isAuthorized"}),c.prototype.logout=function(){return i.clear()},c}()}])}.call(this),function(){angular.module("rbs-angular-auth-ui-router").config(["$httpProvider","ConfigurationProvider",function(r,t){return t.put("DATA_AUTHORIZATION_KEY","authorize"),t.put("ROUTER_AUTHORIZATION_ERROR_EVENT","rbs-angular-auth-ui-router-error"),t.put("ERROR_CODE",{NO_ROUTE_AUTHORIZATION:"0a38f636-c123-4cd5-9249-ad9b6c6724a9"})}]),angular.module("rbs-angular-auth-ui-router").run(["$log","$rootScope","Configuration","ErrorFactory","SecurityCtrlInstance",function(r,t,n,e,a){return t.$on("$stateChangeStart",function(r,o,u,i,c){var l,s,p;return l=null!=(p=o.data)?p[n.DATA_AUTHORIZATION_KEY]:void 0,l&&(s=function(){var r,t;if(l===!0)try{if(!a.isAuthenticated())return e.create(n.ERROR_STATUS.NOT_AUTHORIZED,n.ERROR_CODE.NO_ROUTE_AUTHORIZATION,'State "'+o.name+'" is guarded with authorization rule: "'+l+'", which is not matched')}catch(r){return s=r}else if(angular.isString(l))try{if(!a.isAuthorized(l))return e.create(n.ERROR_STATUS.NOT_AUTHORIZED,n.ERROR_CODE.NO_ROUTE_AUTHORIZATION,'State "'+o.name+'" is guarded with authorization rule: "'+l+'", which is not matched')}catch(t){return s=t}}(),null!=s)?(t.$broadcast(n.ROUTER_AUTHORIZATION_ERROR_EVENT,o,u,i,c,s),r.preventDefault()):void 0})}])}.call(this),function(){var r,t,n,e,a;r="Authorization",t=/Bearer ([0-9A-Za-z\.\-_]+)/,n="Bearer {{token}}",a=function(t,e){return null==t&&(t=r),null==e&&(e=n),function(r,n){return r.headers[t]=angular.isString(e)?S(e).template({token:n,rawToken:n}).s:angular.isFunction(e)?e(n):n}},angular.module("rbs-angular-auth").constant("TemplateTokenInjector",a),e=function(n,e){return null==n&&(n=r),null==e&&(e=t),function(r){var t,a,o,u;if(t=r.headers(n),null!=t){if(!_.isRegExp(e))return angular.isFunction(e)?e(t):t;if(a=e.exec(t),angular.isArray(a))return u=a[0],o=a[1]}}},angular.module("rbs-angular-auth").constant("TemplateTokenExtractor",e),angular.module("rbs-angular-auth").config(["$httpProvider","ConfigurationProvider","TemplateTokenExtractor","TemplateTokenInjector",function(r,t,n,e){return t.put("JWT_STORAGE_KEY","JWT"),t.put("SECURITY_CONTROLLER_AS","security"),t.put("JWT_STORE_EVENT","rbs-angular-auth-JWT-store"),t.put("JWT_CLEAR_EVENT","rbs-angular-auth-JWT-clear"),t.put("HTTP_URL_FILTER",function(){return!0}),t.put("HTTP_AUTHORIZATION_ERROR_STATUS",[401,403]),t.put("HTTP_AUTHORIZATION_ERROR_EVENT","rbs-angular-auth-http-error"),t.put("JWT_PERMISSION_CHECK",_.constant(!1)),t.put("JWT_INJECTOR",e()),t.put("JWT_EXTRACTOR",n()),t.put("ERROR_STATUS",{BAD_REQUEST:400,NOT_AUTHORIZED:401,FORBIDDEN:403}),t.put("ERROR_CODE",{INVALID_TOKEN_SIGNATURE:"3b2600fb-8d22-497c-a49b-3dab0b501f04",INVALID_AUTHORIZATION_RULE:"6af67e3a-23bc-4e5d-a46b-839e1ad7425f",NO_HTTP_AUTHORIZATION:"c472ad9e-d303-4880-aa92-f788c2b0030e"}),t.put("JWT_REQUEST_PARAM","access_token"),r.interceptors.push("SecurityErrorInterceptor"),r.interceptors.push("TokenInterceptor")}]),angular.module("rbs-angular-auth").factory("SecurityCtrlInstance",["$log","SecurityCtrl",function(r,t){return new t}]),angular.module("rbs-angular-auth").run(["$log","$rootScope","Configuration","SecurityCtrlInstance",function(r,t,n,e){return t[n.SECURITY_CONTROLLER_AS]=e}])}.call(this);
//# sourceMappingURL=rbs-angular-auth.min.js.map
